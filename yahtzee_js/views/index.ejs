<html>
  <head>
    <title>Yahtzee: <span id ="username"><%=username%></span></title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/socket.io/socket.io.js"> </script>

</head>


    <body class="notnav">
        <h1><span id="game_name_info"><%=game_name%></span>: <span id="username_info"><%=username%></span></h1>

        <section id="save_and_load">
            <table>
                <tr>                
                    <td colspan="2"><button id="save_game" type="button">Save Game</button></td>
                    <td colspan="2"><button id="load_game" type="button">Load Game</button></td>
                </tr>
            </table>
        </section>
        <section id="dice">
            <table>
              <tr>
                <td><img id="die_0" class="die" src="/img/blank.svg" width="70" /></td>
                <td><img id="die_1" class="die" src="/img/blank.svg" width="70" /></td>
                <td><img id="die_2" class="die" src="/img/blank.svg" width="70" /></td>
                <td><img id="die_3" class="die" src="/img/blank.svg" width="70" /></td>
                <td><img id="die_4" class="die" src="/img/blank.svg" width="70" /></td>
              </tr>
              <tr>
                <td colspan="3">Rolls remaining: <span id="rolls_remaining">3</span></td>
                <td colspan="2"><button id="roll_button" type="button">Roll the Dice!</button></td>
              </tr>
            </table>
            <br>
          </section>
          <section id="players">
            <ol>
            </ol>
  
          </section>
          <section id="feedback">
            <feedback content id="feedback"></feedback>
          </section>
          <input type="hidden" id="uname" name="username" value="<%=username%>"> 

          <section id="scorecard">
            <table>
              <tr>
                <th>UPPER SECTION</th>
                <th>HOW TO SCORE</th>
                <th>#1</th>
              </tr>
              <tr>
                <td>one <img src="/img/one.svg" width="20" /> =1</td>
                <td>Count and Add Only one</td>
                <td><input type="text" class="upper category" id="one_input" size="3"></td>
              </tr>
              <tr>
                <td>two <img src="/img/two.svg" width="20" /> =2</td>
                <td>Count and Add Only two</td>
                <td><input type="text" class="upper category" id="two_input" size="3"></td>
              </tr>
              <tr>
                <td>three <img src="/img/three.svg" width="20" /> =3</td>
                <td>Count and Add Only three</td>
                <td><input type="text" class="upper category" id="three_input" size="3"></td>
              </tr>
              <tr>
                <td>four <img src="/img/four.svg" width="20" /> =4</td>
                <td>Count and Add Only four</td>
                <td><input type="text" class="upper category" id="four_input" size="3"></td>
              </tr>
              <tr>
                <td>five <img src="/img/five.svg" width="20" /> =5</td>
                <td>Count and Add Only five</td>
                <td><input type="text" class="upper category" id="five_input" size="3"></td>
              </tr>
              <tr>
                <td>six <img src="/img/six.svg" width="20" /> =6</td>
                <td>Count and Add Only six</td>
                <td><input type="text" class="upper category" id="six_input" size="3"></td>
              </tr>
              <tr>
                <td>TOTAL SCORE</td>
                <td> -- </td>
                <td class="upper score" id="upper_score"></td>
              </tr>
              <tr>
                <td>BONUS</td>
                <td> If total score is more than 63, score 35 </td>
                <td class="upper score" id="upper_bonus"></td>
              </tr>
              <tr>
                <td>TOTAL</td>
                <td> of upper section </td>
                <td class="upper score" id="upper_total"></td>
              </tr>
              <tr>
                <th>LOWER SECTION</th>
                <th></th>
                <th></th>
              </tr>
              <tr>
                <td>3 of a kind</td>
                <td>Add Total of All Dice</td>
                <td><input type="text" class="lower category" id="three_of_a_kind_input" size="3"></td>
              </tr>
              <tr>
                <td>4 of a kind</td>
                <td>Add Total of All Dice</td>
                <td><input type="text" class="lower category" id="four_of_a_kind_input" size="3"></td>
              </tr>
              <tr>
                <td>Full House</td>
                <td>Score 25</td>
                <td><input type="text" class="lower category" id="full_house_input" size="3"></td>
              </tr>
              <tr>
                <td>Small Straight (Sequence of 4)</td>
                <td>Score 30</td>
                <td><input type="text" class="lower category" id="small_straight_input" size="3"></td>
              </tr>
              <tr>
                <td>Large Straight (Sequence of 5)</td>
                <td>Score 40</td>
                <td><input type="text" class="lower category" id="large_straight_input" size="3"></td>
              </tr>
              <tr>
                <td>Yahtzee (5 of a kind)</td>
                <td>Score 50</td>
                <td><input type="text" class="lower category" id="yahtzee_input" size="3"></td>
              </tr>
              <tr>
                <td>Chance</td>
                <td>Score Total Of all 5 Dice</td>
                <td><input type="text" class="lower category" id="chance_input" size="3"></td>
              </tr>
              <tr>
                <td>Total (Of Lower Section) </td>
                <td></td>
                <td class="lower score" id="lower_score"></td>
              </tr>
              <tr>
                <td>Total (Of Upper Section)</td>
                <td></td>
                <td class="lower score" id="upper_total_lower"></td>
              </tr>
              <tr>
                <td>Grand Total </td>
                <td></td>
                <td class="lower score" id="grand_total"></td>
              </tr>
            </table>
          </section>
          <div id="chat_section">
            <h3>Chat</h3>
            <textarea id="chat_display" name="chat_info"rows="20" cols="50"></textarea>
           <br>
           
           <input type="text" id="chat_message">
           <button type="button" id="chat_button">Send</button>
           <br>
         
           </div>
           <h4>Players in the Game: <span id="game_players">0</span></h4>
           <h4>Yahtzee Players Currently Online: <span id="total_players">0</span></h4>

          <footer></footer>
          <script  src="/js/UI.js" type="module"></script>
          <script>

    let socket = io.connect('/');//the default namespace

    console.log('username check<%=username%>')
    socket.emit('game_connection', {username:'<%=username%>', game_name:'<%=game_name%>'}); // THIS goes to the server, not other clients.  HAS to go to server then clients, not from client to client.
    
    socket.on('game_connection', function(data) { // when another user joins the game.
        console.log(data.username+" has joined the game!") // works!
        console.log("socket.on('game_connection') connected")
        //keep track of the current number of connected game players
        let game_players_element = document.getElementById('game_players');
        game_players_element.innerText = data.num_game_connections;
        let chat_display_element = document.getElementById('chat_display');
        let text = " has joined the game!\n";

        // let players = data.players // what client emits with game connection.
        let scorecards = data.scorecards
        console.log(`\n scorecards: ${data.scorecards}`)

        
        
        if(data.username) // if there's a username: add this message to the chat.
           text = data.username+text;

        chat_display_element.value =  chat_display_element.value+text;

        // add another scorecard for player using their scorecard. make sure its updated using the scorecard updated version they send


    });

    socket.on('connection', function(data) {
        console.log("New player has connected to Yahtzee!")
        let total_players_element = document.getElementById('total_players');
        total_players_element.innerText = data.num_total_connections;
    });

    socket.on('chat', function(data) {
        console.log("Chat message received from "+data.username+": "+data.message)
        let chat_display_element = document.getElementById('chat_display');
        let text = data.message+"\n";
        if(data.username)
           text = data.username+": "+text;

        chat_display_element.value+=text;
    });

    // when someone else has a valid score
    // socket.on("valid_score", function(data){
    //   let username = data.username
    //   let scorecard=data.scorecard
    //   console.log(`${username} has a new valid scorecard: ${scorecard}`)
  //     let link = `http://127.0.0.1:8080/scorecards/scorecards_update/${game_name}`
  //     try {
  //     const response = await fetch(link);
  //     if (!response.ok) {
  //         throw new Error(`Response status: ${response.status}`);
  //     }

  //      scorecards = await response.json();
  //     console.log(`Scorecards : ${scorecards}`);
  //     } catch (error) {
  //     console.error(error.message);
  // }

    // })

    // when player reserves/unreserves die, add event listener that socket emits "reserves die"
    // socket.on this will change the other player's screens

    // when player roles dice, add event listener socket.emit("die_rolled")
    // socket.on("die_rolled") update die.


    document.getElementById("chat_button").addEventListener('click', function(){
      let message_data = document.getElementById("chat_message").value;
      console.log("sending: "+message_data);
      socket.emit('chat', {
        username:'<%=username%>',
        game_name:'<%=game_name%>',
        message: message_data
      });
      document.getElementById("chat_message").value="";
    });
    </script>
    </body>

    </html> 